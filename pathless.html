<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>{{.Title}}</title>
		<style>
			*,
			*::before,
			*::after {
				box-sizing: border-box;
				margin: 0;
				scrollbar-width: none;
				-ms-overflow-style: none;
				user-select: none;
			}
			*::-webkit-scrollbar {
				display: none;
			}
			html {
				scroll-behavior: smooth;
			}
			body {
				color: #f1f1f1;
				background-color: black;
				height: 100vh;
				font-family: 'Roboto', sans-serif;
				overflow: hidden;
				display: flex;
				flex-direction: row;
				border: medium solid blue;
				border-radius: 0.3125em;
			}
			body.horizontal {
				flex-direction: column;
			}
			a,
			a:hover,
			a:visited,
			a:active,
			a:focus {
				text-align: center;
				color: inherit;
				text-decoration: underline;
			}
			.split {
				flex: 1;
				overflow: hidden;
			}
			/* Hide splits based on layout mode */
			body.layout-1 #one,
			body.layout-1 #two,
			body.layout-1 .half,
			body.layout-2 #two {
				display: none;
			}
			.half {
				flex: 1;
				display: flex;
				flex-direction: column;
			}
			body.layout-2 .half {
				display: contents;
			}
			body.horizontal .half {
				flex-direction: row;
			}
			/* Internal borders - only between visible splits */
			/* 2-split vertical: border between #zero and #one */
			body.layout-2 #zero {
				border-right: medium solid blue;
			}
			/* 2-split horizontal: border between #zero and #one */
			body.layout-2.horizontal #zero {
				border-right: none;
				border-bottom: medium solid blue;
			}
			/* 3-split vertical: border right of #zero, border bottom of #one */
			body.layout-3 #zero {
				border-right: medium solid blue;
			}
			body.layout-3 #one {
				border-bottom: medium solid blue;
			}
			/* 3-split horizontal: border bottom of #zero, border right of #one */
			body.layout-3.horizontal #zero {
				border-right: none;
				border-bottom: medium solid blue;
			}
			body.layout-3.horizontal #one {
				border-bottom: none;
				border-right: medium solid blue;
			}
		</style>
		<script>
			const API_URL = '{{.APIURL}}';
			const SPLIT_IDS = ['zero', 'one', 'two'];

			// State
			const state = {
				totalFrames: 0,
				cache: new Map(),
				splits: new Map([
					[0, { idx: 0 }],
					[1, { idx: 0 }],
					[2, { idx: 0 }],
				]),
				layout: { mode: 1, horizontal: false },
				focus: 0,
				loading: new Set(),
				pendingLoads: new Map(),
			};

			// Utilities
			const clamp = (val, min, max) => Math.max(min, Math.min(val, max));
			const visibleSplits = () => [0, 1, 2].slice(0, state.layout.mode);
			const getSplit = (id) => state.splits.get(id);
			const getElement = (id) => document.getElementById(SPLIT_IDS[id]);

			// Navigation
			const navigate = (id, dir) => {
				const s = getSplit(id);
				const next = clamp(s.idx + dir, 0, state.totalFrames - 1);
				if (next !== s.idx) load(id, next);
			};

			// Rendering
			const render = (id) => {
				const content = state.cache.get(getSplit(id).idx);
				if (content) getElement(id).innerHTML = content;
			};

			// Loading
			const load = async (id, idx) => {
				if (idx < 0 || (state.totalFrames && idx >= state.totalFrames))
					return;

				// Use cache
				if (state.cache.has(idx)) {
					if (id !== null) {
						getSplit(id).idx = idx;
						render(id);
					}
					return;
				}

				// Await pending load
				if (state.pendingLoads.has(idx)) {
					await state.pendingLoads.get(idx);
					if (id !== null) {
						getSplit(id).idx = idx;
						render(id);
					}
					return;
				}

				// Fetch
				state.loading.add(idx);
				const promise = fetch(API_URL, {
					headers: { 'X-Frame-Request': idx },
				})
					.then((r) => {
						if (!r.ok) throw new Error(`HTTP ${r.status}`);
						const total = r.headers.get('X-Total-Frames');
						if (total) state.totalFrames = +total;
						const confirmed = +(r.headers.get('X-Frame') ?? idx);
						return r.text().then((html) => ({ confirmed, html }));
					})
					.then(({ confirmed, html }) => {
						state.cache.set(confirmed, html);
						if (id !== null) {
							getSplit(id).idx = confirmed;
							render(id);
						}
					})
					.catch((e) => console.error(`Load failed (${idx}):`, e))
					.finally(() => {
						state.loading.delete(idx);
						state.pendingLoads.delete(idx);
					});

				state.pendingLoads.set(idx, promise);
				await promise;
			};

			// Operations
			const swap = (id1, id2) => {
				const [i1, i2] = [getSplit(id1).idx, getSplit(id2).idx];
				getSplit(id1).idx = i2;
				getSplit(id2).idx = i1;
				render(id1);
				render(id2);
			};

			const swapContent = () => {
				const { mode } = state.layout;
				if (mode === 1) return;
				if (mode === 2) swap(0, 1);
				else if (state.focus) swap(0, state.focus);
			};

			const setLayout = (mode) => {
				const prev = state.layout.mode;
				state.layout.mode = mode;

				// Update classes
				document.body.className = `layout-${mode}${
					state.layout.horizontal ? ' horizontal' : ''
				}`;

				// Fix focus
				const visible = visibleSplits();
				if (!visible.includes(state.focus)) state.focus = 0;

				// Lazy load new splits
				if (mode > prev) {
					visible
						.slice(prev)
						.forEach((id) => load(id, getSplit(id).idx));
				}
			};

			const cycleFocus = () => {
				if (state.layout.mode > 1) {
					const visible = visibleSplits();
					state.focus =
						visible[
							(visible.indexOf(state.focus) + 1) % visible.length
						];
				}
			};

			const toggleOrientation = () => {
				if (state.layout.mode > 1) {
					state.layout.horizontal = !state.layout.horizontal;
					document.body.classList.toggle('horizontal');
				}
			};

			// Events
			const keys = {
				e: () => navigate(state.focus, 1),
				q: () => navigate(state.focus, -1),
				tab: (e) =>
					state.layout.mode > 1 && (e.preventDefault(), cycleFocus()),
				1: () => setLayout(1),
				2: () => setLayout(2),
				3: () => setLayout(3),
				s: swapContent,
				o: toggleOrientation,
			};

			document.addEventListener('keydown', (e) =>
				keys[e.key.toLowerCase()]?.(e)
			);
			document.addEventListener('DOMContentLoaded', () => {
				document.body.className = `layout-${state.layout.mode}`;
				load(0, 0);
			});
		</script>
	</head>
	<body>
		<div id="zero" class="split"></div>
		<div class="half">
			<div id="one" class="split"></div>
			<div id="two" class="split"></div>
		</div>
	</body>
</html>
