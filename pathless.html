<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>{{.Title}}</title>
		<style>
			*,
			*::before,
			*::after {
				box-sizing: border-box;
				margin: 0;
				scrollbar-width: none;
				-ms-overflow-style: none;
				user-select: none;
			}
			*::-webkit-scrollbar {
				display: none;
			}
			html {
				scroll-behavior: smooth;
			}
			body {
				color: #f1f1f1;
				background-color: black;
				height: 100vh;
				font-family: 'Roboto', sans-serif;
				overflow: hidden;
				display: flex;
				flex-direction: row;
				border: medium solid blue;
				border-radius: 0.3125em;
			}
			body.horizontal {
				flex-direction: column;
			}
			a,
			a:hover,
			a:visited,
			a:active,
			a:focus {
				text-align: center;
				color: inherit;
				text-decoration: underline;
			}
			.split {
				flex: 1;
				overflow: hidden;
			}
			#split0 {
				border-right: medium solid blue;
			}
			body.horizontal #split0 {
				border-right: none;
				border-bottom: medium solid blue;
			}
			body.layout-1 #split0 {
				border: none;
			}
			body.layout-1 #split1,
			body.layout-1 #split2,
			body.layout-1 .right-container,
			body.layout-2 #split2 {
				display: none;
			}
			.right-container {
				flex: 1;
				display: flex;
				flex-direction: column;
			}
			body.layout-2 .right-container {
				display: contents;
			}
			body.horizontal .right-container {
				flex-direction: row;
			}
			#split1 {
				border-bottom: medium solid blue;
			}
			body.horizontal #split1 {
				border-bottom: none;
				border-right: medium solid blue;
			}
			body.layout-2 #split1 {
				border: none;
			}
		</style>
		<script>
			const API_URL = '{{.APIURL}}';
			const state = {
				frames: Array(3)
					.fill(null)
					.map(() => ({ content: '', nav: { prev: 0, next: 0 } })),
				mapping: [0, 1, 2],
				focusedSplit: 0,
				layoutMode: 1,
				lastSwap: null,
			};

			const render = () => {
				['split0', 'split1', 'split2'].forEach((id, i) => {
					document.getElementById(id).innerHTML =
						state.frames[state.mapping[i]].content;
				});
			};

			const loadFrame = (frameIndex, contentIndex) => {
				fetch(API_URL, { headers: { Y: contentIndex } })
					.then((res) => {
						state.frames[frameIndex].nav.prev = parseInt(
							res.headers.get('X')
						);
						state.frames[frameIndex].nav.next = parseInt(
							res.headers.get('Z')
						);
						return res.text();
					})
					.then((html) => {
						state.frames[frameIndex].content = html;
						render();
					})
					.catch(console.error);
			};

			const setLayout = (mode) => {
				const wasHorizontal =
					document.body.classList.contains('horizontal');
				state.layoutMode = mode;
				document.body.className = `layout-${mode}`;
				if (wasHorizontal && mode > 1)
					document.body.classList.add('horizontal');
				state.focusedSplit = Math.min(state.focusedSplit, mode - 1);
				state.lastSwap = null;
			};

			const swapContent = () => {
				if (state.layoutMode === 1) return;

				const { mapping, focusedSplit, layoutMode } = state;

				if (layoutMode === 2) {
					[mapping[0], mapping[1]] = [mapping[1], mapping[0]];
				} else {
					if (focusedSplit === 0) {
						if (state.lastSwap !== null) {
							[mapping[0], mapping[state.lastSwap]] = [
								mapping[state.lastSwap],
								mapping[0],
							];
							state.lastSwap = null;
						}
					} else {
						[mapping[0], mapping[focusedSplit]] = [
							mapping[focusedSplit],
							mapping[0],
						];
						state.lastSwap = focusedSplit;
					}
				}
				render();
			};

			const keyActions = {
				e: () =>
					loadFrame(
						state.mapping[state.focusedSplit],
						state.frames[state.mapping[state.focusedSplit]].nav.next
					),
				q: () =>
					loadFrame(
						state.mapping[state.focusedSplit],
						state.frames[state.mapping[state.focusedSplit]].nav.prev
					),
				tab: (e) => {
					if (state.layoutMode > 1) {
						e.preventDefault();
						state.focusedSplit =
							(state.focusedSplit + 1) % state.layoutMode;
					}
				},
				1: () => setLayout(1),
				2: () => setLayout(2),
				3: () => setLayout(3),
				s: swapContent,
				o: () =>
					state.layoutMode > 1 &&
					document.body.classList.toggle('horizontal'),
			};

			document.addEventListener('keydown', (e) => {
				const action = keyActions[e.key.toLowerCase()];
				if (action) action(e);
			});

			document.addEventListener('DOMContentLoaded', () => {
				document.body.className = `layout-${state.layoutMode}`;
				state.frames.forEach((_, i) => loadFrame(i, 0));
			});
		</script>
	</head>
	<body>
		<div id="split0" class="split"></div>
		<div class="right-container">
			<div id="split1" class="split"></div>
			<div id="split2" class="split"></div>
		</div>
	</body>
</html>
