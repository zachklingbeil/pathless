<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>{{.Title}}</title>
		<style>
			:root {
				--border: medium solid blue;
			}
			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
				user-select: none;
				scrollbar-width: none;
				-ms-overflow-style: none;
			}
			*::-webkit-scrollbar {
				display: none;
			}
			html,
			body {
				height: 100vh;
				overflow: hidden;
				font-family: 'Roboto', sans-serif;
				background: black;
				color: white;
				scroll-behavior: smooth;
			}
			body {
				border: var(--border);
				border-radius: 0.3125em;
			}
			a {
				color: inherit;
				text-decoration: underline;
				text-align: center;
			}
			img {
				max-width: 100%;
				max-height: 90%;
				width: auto;
				height: auto;
				display: block;
				object-fit: contain;
			}
			#app {
				height: 100vh;
				display: grid;
			}
			.panel {
				display: flex;
				align-items: center;
				justify-content: center;
				padding: 1em;
				overflow: hidden;
			}
			.panel > * {
				max-width: 100%;
				object-fit: contain;
			}
			.layout-0-0 {
				grid-template: 1fr / 1fr;
			}
			.layout-1-0 {
				grid-template: 1fr / 1fr 1fr;
			}
			.layout-1-0 .panel:nth-child(1) {
				border-right: var(--border);
			}
			.layout-1-1 {
				grid-template: 1fr 1fr / 1fr;
			}
			.layout-1-1 .panel:nth-child(1) {
				border-bottom: var(--border);
			}
			.layout-2-0,
			.layout-2-1,
			.layout-2-2,
			.layout-2-3 {
				grid-template: 1fr 1fr / 1fr 1fr;
			}
			.layout-2-0 .panel:nth-child(1) {
				grid-row: 1 / 3;
				border-right: var(--border);
			}
			.layout-2-0 .panel:nth-child(2) {
				border-bottom: var(--border);
			}
			.layout-2-1 .panel:nth-child(1) {
				grid-column: 1 / 3;
				border-bottom: var(--border);
			}
			.layout-2-1 .panel:nth-child(2) {
				border-right: var(--border);
				border-bottom: var(--border);
			}
			.layout-2-2 .panel:nth-child(1) {
				grid-column: 1;
				grid-row: 1;
			}
			.layout-2-2 .panel:nth-child(2) {
				grid-column: 1;
				grid-row: 2;
				border-top: var(--border);
			}
			.layout-2-2 .panel:nth-child(3) {
				grid-row: 1 / 3;
				grid-column: 2;
				border-left: var(--border);
			}
			.layout-2-3 .panel:nth-child(1) {
				border-right: var(--border);
			}
			.layout-2-3 .panel:nth-child(3) {
				grid-column: 1 / 3;
				border-top: var(--border);
			}
		</style>
		<script>
			class FrameViewer {
				constructor(apiUrl) {
					window.apiUrl = apiUrl;
					this.cache = new Map();
					this.totalFrames = null;
					this.app = document.getElementById('app');
					this.frames = [0, 0, 0];
					this.layout = 0;
					this.variant = 0;
					this.focus = 0;
					this.layouts = [
						{ panels: 1, variants: 1, rotate: null },
						{ panels: 2, variants: 2, rotate: [1, 0] },
						{ panels: 3, variants: 4, rotate: [2, 0, 1] },
					];
					document.addEventListener('keydown', (e) =>
						this.handleKey(e)
					);
					this.setLayout(0);
					this.render();
				}
				get config() {
					return this.layouts[this.layout];
				}
				getPanel(index) {
					return this.app.children[index];
				}
				getFocusedPanel() {
					return this.getPanel(this.focus);
				}
				validateFrame(idx) {
					return typeof idx === 'number' && !isNaN(idx) ? idx : 0;
				}
				cycleFocus() {
					this.focus = (this.focus + 1) % this.config.panels;
				}
				rotateFrames() {
					if (this.config.rotate) {
						this.frames = this.config.rotate.map((i) =>
							this.validateFrame(this.frames[i])
						);
						this.cycleFocus();
						this.render();
					}
				}
				handleKey(e) {
					const actions = {
						1: () => this.setLayout(0),
						2: () => this.setLayout(1),
						3: () => this.setLayout(2),
						4: () => this.rotateFrames(),
						Tab: () => (e.preventDefault(), this.cycleFocus()),
						e: () => this.navigate(1),
						q: () => this.navigate(-1),
					};
					const action = actions[e.key];
					if (action) {
						action();
					}
					this.getFocusedPanel()?.dispatchEvent(
						new CustomEvent('panelKey', { detail: e })
					);
				}
				navigate(delta) {
					const max = this.totalFrames ?? 1000;
					this.frames[this.focus] = this.validateFrame(
						(this.frames[this.focus] + delta + max) % max
					);
					this.render([this.focus]);
				}
				async fetchFrame(idx) {
					if (this.cache.has(idx)) return this.cache.get(idx);
					let html;
					if (!window.apiUrl) {
						html = '<div>No API URL configured</div>';
					} else {
						try {
							const res = await fetch(window.apiUrl, {
								headers: { 'X-Frame': idx.toString() },
							});
							if (!res.ok) throw new Error(`HTTP ${res.status}`);
							const total = res.headers.get('X-Index');
							if (total && !this.totalFrames) {
								this.totalFrames = parseInt(total);
							}
							html = await res.text();
						} catch (err) {
							console.error(`Failed to fetch frame ${idx}:`, err);
							html = `<div>Error loading frame ${idx}</div>`;
						}
					}
					this.cache.set(idx, html);
					return html;
				}
				setLayout(layout) {
					const layoutChanged = this.layout !== layout;
					if (!layoutChanged) {
						this.variant =
							(this.variant + 1) % this.config.variants;
					} else {
						if (this.focus >= this.layouts[layout].panels) {
							[this.frames[0], this.frames[this.focus]] = [
								this.frames[this.focus],
								this.frames[0],
							];
							this.focus = 0;
						}
						this.layout = layout;
						this.variant = 0;
					}
					this.updateLayoutDOM();
					if (layoutChanged) {
						this.render();
					}
				}
				updateLayoutDOM() {
					this.app.className = `layout-${this.layout}-${this.variant}`;
					for (let i = 0; i < 3; i++) {
						const panel = this.getPanel(i);
						panel.style.display =
							i < this.config.panels ? 'flex' : 'none';
					}
				}
				async renderPanel(panelIndex) {
					const panel = this.getPanel(panelIndex);
					const frameIndex = this.validateFrame(
						this.frames[panelIndex]
					);
					panel.innerHTML = await this.fetchFrame(frameIndex);
					this.executeScripts(panel);
				}
				async render(indices) {
					const panelsToRender = indices ?? [
						...Array(this.config.panels).keys(),
					];
					await Promise.all(
						panelsToRender.map((i) => this.renderPanel(i))
					);
				}
				executeScripts(panel) {
					panel.querySelectorAll('script').forEach((s) => {
						try {
							new Function('panel', s.textContent)(panel);
						} catch (e) {
							console.error('Script execution error:', e);
						}
					});
				}
			}
			document.addEventListener(
				'DOMContentLoaded',
				() => new FrameViewer('{{.APIURL}}')
			);
		</script>
	</head>
	<body>
		<div id="app">
			<div class="panel"></div>
			<div class="panel"></div>
			<div class="panel"></div>
		</div>
	</body>
</html>
