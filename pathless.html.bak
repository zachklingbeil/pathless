<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>{{.Title}}</title>
		<script>
			const API_URL = '{{.APIURL}}';
			const SPLIT_IDS = ['zero', 'one', 'two'];

			// Utilities
			const clamp = (val, min, max) => Math.max(min, Math.min(val, max));
			const visibleSplits = () => [0, 1, 2].slice(0, state.layout.mode);
			const getSplit = (id) => state.splits.get(id);
			const getElement = (id) => document.getElementById(SPLIT_IDS[id]);

			// Navigation
			const navigate = (id, dir) => {
				const s = getSplit(id);
				const next = clamp(s.idx + dir, 0, state.totalFrames - 1);
				if (next !== s.idx) load(id, next);
			};

			// Rendering
			const render = (id) => {
				const content = state.cache.get(getSplit(id).idx);
				if (content) getElement(id).innerHTML = content;
			};

			// Loading
			const load = async (id, idx) => {
				if (idx < 0 || (state.totalFrames && idx >= state.totalFrames))
					return;

				// Use cache
				if (state.cache.has(idx)) {
					if (id !== null) {
						getSplit(id).idx = idx;
						render(id);
					}
					return;
				}

				// Await pending load
				if (state.pendingLoads.has(idx)) {
					await state.pendingLoads.get(idx);
					if (id !== null) {
						getSplit(id).idx = idx;
						render(id);
					}
					return;
				}

				// Fetch
				state.loading.add(idx);
				const promise = fetch(API_URL, {
					headers: { 'X-Frame-Request': idx },
				})
					.then((r) => {
						if (!r.ok) throw new Error(`HTTP ${r.status}`);
						const total = r.headers.get('X-Total-Frames');
						if (total) state.totalFrames = +total;
						const confirmed = +(r.headers.get('X-Frame') ?? idx);
						return r.text().then((html) => ({ confirmed, html }));
					})
					.then(({ confirmed, html }) => {
						state.cache.set(confirmed, html);
						if (id !== null) {
							getSplit(id).idx = confirmed;
							render(id);
						}
					})
					.catch((e) => console.error(`Load failed (${idx}):`, e))
					.finally(() => {
						state.loading.delete(idx);
						state.pendingLoads.delete(idx);
					});

				state.pendingLoads.set(idx, promise);
				await promise;
			};
			// Events
			const keys = {
				e: () => navigate(state.focus, 1),
				q: () => navigate(state.focus, -1),
				tab: (e) =>
					state.layout.mode > 1 && (e.preventDefault(), cycleFocus()),
				1: () => setLayout(1),
				2: () => setLayout(2),
				3: () => setLayout(3),
				s: swapContent,
				o: toggleOrientation,
			};

			document.addEventListener('keydown', (e) =>
				keys[e.key.toLowerCase()]?.(e)
			);
			document.addEventListener('DOMContentLoaded', () => {
				document.body.className = `layout-${state.layout.mode}`;
				load(0, 0);
			});
		</script>
	</head>
	<body>
		<div id="zero" class="split"></div>
		<div class="half">
			<div id="one" class="split"></div>
			<div id="two" class="split"></div>
		</div>
	</body>
</html>
